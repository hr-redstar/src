# カスタムID 仕様書（v2／確定版）

Custom ID は、ボットのインタラクション（ボタン、セレクトメニュー、モーダル）を識別するための唯一の識別子です。

## 1. 形式仕様

### v2 正式形式 (Current)
`namespace|action|params`

- **namespace**: 機能カテゴリ。システムのルーティングに使用。
- **action**: 実行する動作。動詞・現在形で定義。
- **params**: `key=value` 形式のパラメータ。`&` で連結。
  例: `ps|send|panel=rideList`

### v1 形式 (Legacy / 後方互換)
`namespace:action:param1:param2...`
※ 移行期間中のみサポートされ、`parseCustomId.js` により内部的に v2 互換オブジェクトへ変換されます。

## 2. 構成要素の命名・運用ルール

- **namespace**: 16文字以内。 (例: `ps`, `ride`, `reg`, `adm`, `dispatch`)
- **action**: 24文字以内。 snake_case は避け、直感的な動詞を使用する (例: `send`, `select`, `start`, `cancel`, `approve`)。
- **params**: 
  - キーと値を `=` で結び、複数は `&` で連結する。
  - 予約キー: `panel`, `vc`, `uid`, `mid`。
  - 値に `|` や `&`, `=` を含める場合はエンコードが必要（推奨されない）。

## 3. 制限事項

- **長さ制限**: Discord の制限により、Custom ID 全体は **100文字以内** でなければなりません。
- **推奨値**:
  - `namespace`: 16文字以内
  - `action`: 24文字以内
  - `params` 合計: 50文字以内

## 4. セキュリティ指針

**Custom ID は 信頼しないこと。**
- **禁止事項**: 生の `userId` を直接含めること、任意文字列の自由な連結。
- **推奨事項**: 内部マップの参照キー、短縮された識別子、またはシステムが発行した一時的なトークンを使用する。
- **検証**: 実行時に必ず、操作者がその Custom ID に基づく権限を持っているか（例: 自分の車への相乗り承認か等）をハンドラー側で再検証すること。

## 5. エラー時挙動

- `parseCustomId` はパースに失敗した場合、例外を投げず **`null`** を返します。
- **呼び出し側の責務**: `parsed` が `null` の場合は、即座に処理を中断（`return`）しなければなりません。

## 6. 将来の拡張方針

- フィールドの追加は常に `|` 区切りでのみ行います。
- 既存のフィールド（特に `namespace`, `action`）の意味を変更する「破壊的変更」は禁止します。
- 将来的に構造が複雑化する場合は、JSONシリアライズやBase64エンコードの導入を検討します。
