# 利用者パネル仕様書

## 1. パネル概要
**利用者パネル** は、一般利用者が送迎を依頼するためのインターフェースです。
待機中の送迎車と即座にマッチングを行い、プライベートVCを通じて送迎の調整を行います。

## 2. パネル表示内容 (Embed)

### タイトル
**👤 利用者パネル**

### 本文
```text
現在の送迎車： {待機中(Waiting) + 送迎中(Working) の合計人数} 台
自分・ゲストの送迎依頼ができます
```

### ボタン構成
1.  **🚕 配車依頼** (`dispatch:order:type` -> `user:ride:request`)
    *   自分自身の送迎依頼を行います。
2.  **👥 ゲスト依頼** (`user:ride:guest`)
    *   ゲスト（知人など）のための送迎依頼を行います。
3.  **✅ 登録状態確認** (`user:check`)
    *   現在の利用者登録情報を確認します (Ephemeral)。

---

## 3. 配車依頼フロー

### 3.1. モーダル入力
ボタン押下後、以下の入力フォームが表示されます。
登録済みの情報は自動的に入力されます。

| 項目名 | 必須 | デフォルト値 | 制約 |
| :--- | :---: | :--- | :--- |
| **方面** | ✅ | ユーザー登録情報の「方面」 | 最大100文字 |
| **目的地** | ✅ | "口頭で伝える" | 最大50文字 |

### 3.2. マッチング処理
1.  **待機列チェック**: FIFO順で最前列の「待機中」ドライバーを取得 (`popNextDriver`)。
2.  **不在時処理**: 待機送迎車が0台の場合は、Ephemeralメッセージでエラーを通知し終了。
3.  **状態更新**: マッチング成立後、送迎リクエストを作成し保存。

### 3.3. コミュニケーション (Private VC & DM)
マッチング成立と同時に、以下のチャンネルと通知が作成されます。

#### プライベートVC (ボイスチャンネル)
*   **作成場所**: `config.categories.privateVc` カテゴリ内
*   **チャンネル名**: `MMDD-HHmm【送迎者場所】→【利用者住所】→【目的地】`
    *   例: `0115-1430【難波】→【〇〇ビル前】→【口頭で伝える】`
*   **権限**:
    *   ✅ 許可: 送迎担当ドライバー、依頼した利用者、Bot/管理者
    *   ❌ 禁止: @everyone (閲覧不可)

#### 通知 (DM)
送迎者・利用者の双方にEmbedメッセージがDM送信されます。

**[内容]**
*   **タイトル**: 🚕 送迎依頼 (または 👥 ゲスト送迎依頼)
*   **詳細**: 送迎者名、利用者名、ルート情報 (住所・目印・目的地)
*   **リンク**: 作成されたプライベートVCへのリンク

---

## 4. ゲスト送迎依頼フロー
基本フローは「配車依頼」と同一です。
以下の点が異なります。

1.  **ボタン**: 「👥 ゲスト依頼」を使用。
2.  **表記**: 通知やモーダルタイトルが「ゲスト送迎依頼」となります。
3.  **データ**: 内部的に `guest: true` フラグが保持されます。

---

## 5. その他の仕様
*   **同時依頼**: 同一ユーザーによる同時刻の複数依頼は制限されません。
    *   VC名に時刻 (HHmm) が付与されるため、チャンネル名の重複は発生しません。
*   **送迎車カウント**: パネル上の「現在の送迎車」は、待機中と送迎中のドライバーの合計です。