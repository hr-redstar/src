# 🚗 送迎者Bot（Discord）

送迎者と利用者をマッチングし、配車・送迎・相乗り・評価までを一貫して管理するDiscord専用の送迎支援Botです。

本Botは **Linux環境を基準** に設計されています。Windows / macOSでの開発・検証は可能ですが、最終的な動作保証はLinux（Google Cloud Run）となります。

---

## 📌 主な機能

### 🚗 送迎者向け
- **出勤（待機開始） / 退勤**: 自身の稼働状況をリアルタイムに管理。
- **現在地・停留場所登録**: マッチング精度向上のための位置情報管理。
- **送迎開始 / 終了操作**: シンプルなボタン操作でステータスを遷移。
- **相乗り対応**: リアルタイムな乗車人数管理と承認フロー。

### 👤 利用者向け
- **柔軟な配車依頼**: 種別（キャスト / ゲスト）、方面・人数・目的地の指定。
- **プライベート連絡チャンネル**: マッチング成立時に専用VC / テキストを自動生成。
- **1件1Embed更新型ログ**: 送迎1件につき1メッセージを更新して追跡。
- **スレッド型登録台帳**: 1人1メッセージで常に最新状態を保持し、大規模運用に対応。
- **口コミ評価システム**: 送迎終了後に相互評価DMを送信し、ランクパネルに反映。

### 🛠 管理者向け
- **各種パネル設置**: 管理者・送迎・利用者用パネルの簡単設置。
- **送迎履歴・統計管理**: 運用データの蓄積と可視化。
- **評価・ランク管理**: ユーザーごとの品質・貢献度管理。
- **強制退勤・状態クリーンアップ**: トラブル時や退勤忘れのセーフティ機能。

## 🏆 Primary Features (v1.0.0 Professional Edition 🔐)

本システムは、送迎オペレーションの「可視化」と「信頼性向上」を極限まで高めたプロフェッショナル版です。
2026年1月25日をもってアーキテクチャは **凍結（Freeze）** され、長期的な安定運用フェーズへ移行しました。

### 🛡️ インフラ整合性 (Freeze Compliance)
*   **整合性保護**: `npm run freeze:guard` により、UI標準違反やマジックストリングの混入を機械的に阻止。
*   **不変のアーキテクチャ**: `DEV.md` による「設計契約」に基づき、将来の破壊的変更を抑止。

### 📊 プロフェッショナル履歴＆監査
- **1-Ride-1-Embed 運行ログ**: 一つの送迎につき一つのメッセージが更新され続ける、スマートな追跡システム。
- **ヒストリカルデータ分析**: 過去の配車記録や稼働統計を、管理画面から瞬時に検索・閲覧。
- **詳細出勤ログ**: ドライバーの稼働時間、車両情報、定員設定などを自動記録。

### ⭐ 評価・ランキングシステム
- **相互評価と信頼スコア**: 送迎終了後の相互レビューにより、サーバー内の信頼度を可視化。
- **階級（ランク）制度**: 評価実績に応じたランク（ブロンズ、シルバー等）をプロフィールに自動反映。
- **口コミランクパネル**: サーバー内の活動ランキングをリアルタイム表示。

### 🚗 高度な配車管理
- **配車依頼フローの最適化 (v2.8.0)**: 方面と人数を選択するだけのシンプルかつ直感的な依頼フローへ刷新。
- **方面・地名（エリア）登録**: 方面ごとに詳細な地名リストを管理し、相乗り時の行き先可視性を向上。
- **相乗り (Carpool) 完全対応**: プレミアムレイアウトによるエリア情報の自動表示と募集管理。
- **スマートマッチング**: ドライバーの現在地とステータスを考慮した最適化マッチング。

---

## 🧩 技術仕様
- **Runtime**: Node.js（discord.js v14）
- **Storage**: ファイルベース（JSON）
- **Deployment**: Google Cloud Run（Linux）
- **CI/CD**: GitHub Actions
- **Interaction**: Custom ID v2 (`namespace|action|params`)

---

## 📁 ディレクトリ構成
```text
bot/
├─ index.js           # エントリーポイント
├─ handler/           # Interaction ハンドラ群
├─ utils/             # 共通ユーティリティ
├─ storage/           # ストレージ抽象化
├─ data/              # ※ Git管理外（ローカルデータ）
├─ .env               # ※ Git管理外
└─ ...
```

---

## 🔐 セキュリティ・環境変数
⚠️ **Discord Bot Tokenは絶対にGit管理しないでください。**
- `.env` にのみ記載し、本番環境では Secret Manager 等を使用してください。
- 流出時は直ちに Reset してください。

**.env 例**
```env
DISCORD_TOKEN=your_token_here
```

---

## 💻 開発環境の統一方針
### エディタ設定 (Visual Studio Code)
- **文字コード**: UTF-8
- **改行コード**: LF
- **フォーマッタ**: Prettier

### 実行環境
- **前提**: 本プロジェクトは **日本人向け・日本語運用** を前提としています。
- **基準**: Linux系OS (UTF-8推奨)。
- **テスト**: Linux環境を主軸とし、日本語が正しく扱えない環境はサポート対象外です。
- **背景**: 業務ドメインの即時理解と運用スピードを優先し、日本語ファイル名・日本語ログを一貫して採用しています。

---

## 🚀 セットアップ
```bash
cd bot
npm install
cp .env.example .env
npm run dev
```

### データ整合性 (Optimistic Locking)
- **競合回避**: 複数インスタンスからの同時書き込みを防ぐため、GCSの世代番号（Generation Number）を利用した **楽観的ロック** を実装しています。
- **自動リトライ**: 書き込み時に競合（GCS 412エラー）を検知すると、自動的に最新データを再読み込みして最大5回までリトライします。
- **実装上の注意**: `updateJson` に渡す更新関数（updaterFn）は副作用のない **純粋関数** として実装してください。

---

## 📐 実装ルール
- **パス操作**: `path.join()` を必ず使用。
- **ファイル名**: 大文字・小文字を厳密に管理（Linux基準）。
- **Custom ID**: `namespace|action|params` 形式を厳守。
- **インタラクション応答 (v1.6.1+)**:
    - すべてのパネル操作は `autoInteractionTemplate` を経由すること。
    - **deferReply** を原則とし、`deferUpdate` は（エフェメラルパネルの更新において不整合の原因となるため）原則使用禁止。
    - 応答はすべて `interaction.editReply()` で統一し、3秒ルールを確実に回避する。

---

## 📜 ライセンス
Private / Custom License
